{% form_theme form 'bootstrap_4_layout.html.twig' %}

<style>
    :root {
        --primary-color: #4361ee;
        --success-color: #2ec4b6;
        --error-color: #e63946;
        --text-color: #2b2d42;
        --background-color: #f8f9fa;
        --border-radius: 8px;
        --transition: all 0.3s ease;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        border-radius: var(--border-radius);
        padding: 0.75rem 1rem;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        font-size: 1rem;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }

    .form-control-file {
        padding: 0.5rem;
        border: 2px dashed #e9ecef;
        border-radius: var(--border-radius);
        background: #fff;
        transition: var(--transition);
    }

    .form-control-file:hover {
        border-color: var(--primary-color);
    }

    .form-error {
        color: var(--error-color);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .is-invalid {
        border-color: var(--error-color) !important;
    }

    .is-valid {
        border-color: var(--success-color) !important;
    }

    .error-label, .field-error {
        color: var(--error-color);
        display: none;
        font-size: 0.875rem;
        margin-top: 0.5rem;
        font-weight: 500;
    }

    .field-success {
        color: var(--success-color);
        font-size: 0.875rem;
        margin-top: 0.5rem;
        font-weight: 500;
        display: none;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border-radius: var(--border-radius);
        font-weight: 600;
        transition: var(--transition);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #2c4be3;
        border-color: #2c4be3;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(67, 97, 238, 0.15);
    }

    .btn-disabled {
        background-color: #b4b4b4 !important;
        border-color: #b4b4b4 !important;
        cursor: not-allowed;
        opacity: 0.65;
    }

    .post-form {
        background: #ffffff;
        padding: 2rem;
        border-radius: var(--border-radius);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .form-label {
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 0.5rem;
    }

    .image-preview {
        border-radius: var(--border-radius);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
    }

    .post-type-fields {
        animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .modal-footer {
        border-top: 1px solid #e9ecef;
        padding-top: 1.5rem;
        margin-top: 2rem;
    }

    .form-control.is-valid {
        border-color: var(--success-color) !important;
        background-image: none;
    }

    .form-control.is-invalid {
        border-color: var(--error-color) !important;
        background-image: none;
    }

    .form-control-file.is-valid {
        border-color: var(--success-color) !important;
    }

    .form-control-file.is-invalid {
        border-color: var(--error-color) !important;
    }
</style>

{{ form_start(form, {'attr': {'novalidate': 'novalidate', 'id': 'post-form', 'class': 'post-form'}}) }}
    <div class="form-group">
        {{ form_label(form.type) }}<br>
        {{ form_widget(form.type, {
            'attr': {
                'class': 'form-control' ~ (form.type.vars.valid ? '' : ' is-invalid'),
                'onchange': 'handlePostTypeChange(this.value)',
                'required': 'required'
            }
        }) }}<br>
        <div class="field-error" id="type-error"></div>
        {{ form_errors(form.type, {'attr': {'class': 'form-error'}}) }}
    </div>

    <!-- Common Fields -->
    <div class="form-group">
        {{ form_label(form.id_user) }}<br>
        {{ form_widget(form.id_user, {
            'attr': {
                'class': 'form-control',
                'required': 'required'
            }
        }) }}<br>
        <div class="field-error" id="user-error"></div>
        {{ form_errors(form.id_user) }}
    </div>

    <div class="form-group">
        {{ form_label(form.forum_id) }}<br>
        {{ form_widget(form.forum_id, {
            'attr': {
                'class': 'form-control',
                'required': 'required'
            }
        }) }}<br>
        <div class="field-error" id="forum-error"></div>
        {{ form_errors(form.forum_id) }}
    </div>

    <div class="form-group">
        {{ form_label(form.chemin_fichier) }}<br>
        {% if form.vars.data and form.vars.data.cheminFichier %}
            <div class="mb-2">
                Current image:
                <img src="{{ asset('uploads/' ~ form.vars.data.cheminFichier) }}" 
                     class="image-preview" style="max-width: 200px;">
            </div>
        {% endif %}
        {{ form_widget(form.chemin_fichier, {
            'attr': {
                'class': 'form-control-file',
                'accept': '.jpg,.jpeg,.png',
                'onchange': 'validateFile(this)',
                'required': form.vars.data and form.vars.data.postId ? null : 'required'
            }
        }) }}<br>
        <div class="field-error" id="file-error"></div>
        {{ form_errors(form.chemin_fichier) }}
    </div>

    {% if form.status is defined %}
    <div class="form-group">
        {{ form_label(form.status) }}<br>
        {{ form_widget(form.status, {'attr': {'class': 'form-control'}}) }}<br>
        {{ form_errors(form.status) }}
    </div>
    {% endif %}

    <!-- Survey Fields -->
    <div id="survey-fields" class="post-type-fields" style="display: none;">
        <div class="form-group">
            {{ form_label(form.survey_question) }}<br>
            {{ form_widget(form.survey_question, {
                'attr': {
                    'class': 'form-control',
                    'rows': 3,
                    'onkeyup': 'validateSurveyQuestion(this.value)',
                    'required': 'required'
                }
            }) }}<br>
            <div class="field-error" id="survey-question-error"></div>
            <div class="field-success" id="survey-question-success">Question valide</div>
            {{ form_errors(form.survey_question) }}
        </div>

        <div class="form-group">
            {{ form_label(form.survey_tags) }}<br>
            {{ form_widget(form.survey_tags, {
                'attr': {
                    'class': 'form-control',
                    'onkeyup': 'validateTags(this.value, "survey")',
                    'required': 'required'
                }
            }) }}<br>
            <div class="field-error" id="survey-tags-error"></div>
            <div class="field-success" id="survey-tags-success">Tags valides</div>
            {{ form_errors(form.survey_tags) }}
        </div>
    </div>

    <!-- Announcement Fields -->
    <div id="announcement-fields" class="post-type-fields" style="display: none;">
        <div class="form-group">
            {{ form_label(form.announcement_title) }}<br>
            {{ form_widget(form.announcement_title, {
                'attr': {
                    'class': 'form-control',
                    'onkeyup': 'validateAnnouncementTitle(this.value)',
                    'required': 'required'
                }
            }) }}<br>
            <div class="field-error" id="announcement-title-error"></div>
            <div class="field-success" id="announcement-title-success">Titre valide</div>
            {{ form_errors(form.announcement_title) }}
        </div>

        <div class="form-group">
            {{ form_label(form.announcement_content) }}<br>
            {{ form_widget(form.announcement_content, {
                'attr': {
                    'class': 'form-control',
                    'rows': 5,
                    'onkeyup': 'validateAnnouncementContent(this.value)',
                    'required': 'required'
                }
            }) }}<br>
            <div class="field-error" id="announcement-content-error"></div>
            <div class="field-success" id="announcement-content-success">Contenu valide</div>
            {{ form_errors(form.announcement_content) }}
        </div>

        <div class="form-group">
            {{ form_label(form.announcement_tags) }}<br>
            {{ form_widget(form.announcement_tags, {
                'attr': {
                    'class': 'form-control',
                    'onkeyup': 'validateTags(this.value, "announcement")',
                    'required': 'required'
                }
            }) }}<br>
            <div class="field-error" id="announcement-tags-error"></div>
            <div class="field-success" id="announcement-tags-success">Tags valides</div>
            {{ form_errors(form.announcement_tags) }}
        </div>
    </div>

    <div class="modal-footer">
        <button type="submit" class="btn btn-primary" id="submit-button" disabled>
            {{ form.vars.data and form.vars.data.postId ? 'Update' : 'Create' }}
        </button>
    </div>
{{ form_end(form) }}

<script>
    let formValid = {
        type: false,
        title: false,
        content: false,
        tags: false,
        question: false,
        surveyTags: false,
        file: false
    };

    let originalFormData = null;

    function handlePostTypeChange(type) {
        // Hide all type-specific fields
        document.querySelectorAll('.post-type-fields').forEach(el => {
            el.style.display = 'none';
        });

        // Update type validation
        formValid.type = type !== '';
        
        // Show fields for selected type
        if (type === 'survey') {
            document.getElementById('survey-fields').style.display = 'block';
        } else if (type === 'announcement') {
            document.getElementById('announcement-fields').style.display = 'block';
        }

        updateSubmitButton();
    }

    function validateAnnouncementTitle(title) {
        const field = document.getElementById('post_announcement_title');
        const errorLabel = document.getElementById('announcement-title-error');
        
        if (!title || title.trim() === '') {
            showError(field, errorLabel, "Le titre est requis");
            formValid.title = false;
        } else if (title.length > 50) {
            showError(field, errorLabel, "Le titre ne doit pas dépasser 50 caractères");
            formValid.title = false;
        } else {
            hideError(field, errorLabel);
            formValid.title = true;
        }
        updateSubmitButton();
    }

    function validateAnnouncementContent(content) {
        const field = document.getElementById('post_announcement_content');
        const errorLabel = document.getElementById('announcement-content-error');
        
        if (!content || content.trim() === '') {
            showError(field, errorLabel, "Le contenu est requis");
            formValid.content = false;
        } else if (content.length > 500) {
            showError(field, errorLabel, "Le contenu ne doit pas dépasser 500 caractères");
            formValid.content = false;
        } else {
            hideError(field, errorLabel);
            formValid.content = true;
        }
        updateSubmitButton();
    }

    function validateTags(tags, type) {
        const field = document.getElementById(`post_${type}_tags`);
        const errorLabel = document.getElementById(`${type}-tags-error`);
        
        if (!tags || tags.trim() === '') {
            showError(field, errorLabel, "Les tags sont requis");
            formValid[type === 'survey' ? 'surveyTags' : 'tags'] = false;
        } else if (tags.length > 100) {
            showError(field, errorLabel, "Les tags ne doivent pas dépasser 100 caractères");
            formValid[type === 'survey' ? 'surveyTags' : 'tags'] = false;
        } else if (!tags.match(/^[a-zA-Z0-9,\s]*$/)) {
            showError(field, errorLabel, "Les tags ne doivent contenir que des lettres, chiffres et virgules");
            formValid[type === 'survey' ? 'surveyTags' : 'tags'] = false;
        } else {
            const tagArray = tags.split(',').map(t => t.trim()).filter(t => t);
            const uniqueTags = new Set(tagArray);
            
            if (tagArray.length !== uniqueTags.size) {
                showError(field, errorLabel, "Les tags doivent être uniques");
                formValid[type === 'survey' ? 'surveyTags' : 'tags'] = false;
            } else if (tagArray.some(tag => tag.length > 20)) {
                showError(field, errorLabel, "Chaque tag ne doit pas dépasser 20 caractères");
                formValid[type === 'survey' ? 'surveyTags' : 'tags'] = false;
            } else {
                hideError(field, errorLabel);
                formValid[type === 'survey' ? 'surveyTags' : 'tags'] = true;
            }
        }
        updateSubmitButton();
    }

    function validateSurveyQuestion(question) {
        const field = document.getElementById('post_survey_question');
        const errorLabel = document.getElementById('survey-question-error');
        
        if (!question || question.trim() === '') {
            showError(field, errorLabel, "La question est requise");
            formValid.question = false;
        } else if (question.length > 200) {
            showError(field, errorLabel, "La question ne doit pas dépasser 200 caractères");
            formValid.question = false;
        } else {
            hideError(field, errorLabel);
            formValid.question = true;
        }
        updateSubmitButton();
    }

    function validateFile(input) {
        const errorLabel = document.getElementById('file-error');
        const file = input.files[0];
        const isEdit = document.getElementById('post_type').disabled;
        
        if (!isEdit) {
            if (!file) {
                showError(input, errorLabel, "Une image est requise");
                formValid.file = false;
            } else {
                const validTypes = ['image/jpeg', 'image/png'];
                if (!validTypes.includes(file.type)) {
                    showError(input, errorLabel, "Seuls les fichiers JPG ou PNG sont autorisés");
                    input.value = '';
                    formValid.file = false;
                } else {
                    hideError(input, errorLabel);
                    formValid.file = true;
                }
            }
        } else {
            formValid.file = true;
        }
        updateSubmitButton();
    }

    function updateSubmitButton() {
        const submitBtn = document.getElementById('submit-button');
        const type = document.getElementById('post_type').value;
        const isEdit = document.getElementById('post_type').disabled;
        
        let isValid = formValid.type;
        
        if (type === 'announcement') {
            isValid = isValid && formValid.title && formValid.content && formValid.tags;
        } else if (type === 'survey') {
            isValid = isValid && formValid.question && formValid.surveyTags;
        }
        
        if (!isEdit) {
            isValid = isValid && formValid.file;
        }

        // Check if form data has changed
        const currentFormData = new FormData(document.getElementById('post-form'));
        const hasChanges = !isFormDataEqual(currentFormData, originalFormData);
        
        submitBtn.disabled = !isValid || !hasChanges;
        submitBtn.classList.toggle('btn-disabled', !isValid || !hasChanges);
    }

    function isFormDataEqual(form1, form2) {
        if (!form1 || !form2) return false;
        
        const entries1 = Array.from(form1.entries());
        const entries2 = Array.from(form2.entries());
        
        if (entries1.length !== entries2.length) return false;
        
        for (let i = 0; i < entries1.length; i++) {
            const [key1, value1] = entries1[i];
            const [key2, value2] = entries2[i];
            
            if (key1 !== key2) return false;
            
            // Skip file comparison as it's always different
            if (key1 === 'post[chemin_fichier]') continue;
            
            if (value1 !== value2) return false;
        }
        
        return true;
    }

    function showError(field, errorLabel, message) {
        field.classList.remove('is-valid');
        field.classList.add('is-invalid');
        errorLabel.textContent = message;
        errorLabel.style.display = 'block';
        
        // Hide success message if exists
        const successLabel = document.getElementById(errorLabel.id.replace('-error', '-success'));
        if (successLabel) {
            successLabel.style.display = 'none';
        }
    }

    function hideError(field, errorLabel) {
        field.classList.remove('is-invalid');
        field.classList.add('is-valid');
        errorLabel.style.display = 'none';
        
        // Show success message if exists
        const successLabel = document.getElementById(errorLabel.id.replace('-error', '-success'));
        if (successLabel) {
            successLabel.style.display = 'block';
        }
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        const type = document.getElementById('post_type').value;
        const isEdit = document.getElementById('post_type').disabled;
        
        // Initialize form validation based on type
        formValid.type = true; // Type is always valid in edit mode
        
        // Show the correct fields based on type
        if (type === 'announcement') {
            document.getElementById('announcement-fields').style.display = 'block';
            document.getElementById('survey-fields').style.display = 'none';
            
            // Validate announcement fields
            const title = document.getElementById('post_announcement_title')?.value;
            const content = document.getElementById('post_announcement_content')?.value;
            const tags = document.getElementById('post_announcement_tags')?.value;
            
            if (title) validateAnnouncementTitle(title);
            if (content) validateAnnouncementContent(content);
            if (tags) validateTags(tags, 'announcement');
        } else if (type === 'survey') {
            document.getElementById('survey-fields').style.display = 'block';
            document.getElementById('announcement-fields').style.display = 'none';
            
            // Validate survey fields
            const question = document.getElementById('post_survey_question')?.value;
            const tags = document.getElementById('post_survey_tags')?.value;
            
            if (question) validateSurveyQuestion(question);
            if (tags) validateTags(tags, 'survey');
        }
        
        // Handle file validation
        const fileInput = document.querySelector('input[type="file"]');
        if (fileInput) {
            formValid.file = true; // File is optional in edit mode
        }
        
        // Store original form data for comparison
        originalFormData = new FormData(document.getElementById('post-form'));
        
        // Add change event listeners to all form inputs
        const form = document.getElementById('post-form');
        form.querySelectorAll('input, textarea, select').forEach(input => {
            input.addEventListener('change', () => updateSubmitButton());
            input.addEventListener('keyup', () => updateSubmitButton());
        });
        
        // Initial button state update
        updateSubmitButton();
    });
</script>